{% extends "admin/base_site.html" %}
{% load i18n admin_static %}

{% block title %} Gotcha | API Benchmark for Django {{ block.super }}{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css">
{% endblock %}

{% block content %}

    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-12 col-md-12 main">
            <h1 class="page-header">Url Response Benchmark</h1>
            <h2 class="sub-header"><a href="{{.Url}}" target="_blank">{{.Url}}</a></h2>
        </div>
      </div>
    </div>
    <div id="urlDetailChart" style="height: 250px;"></div>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Response Time</th>
                    <th>Status Code</th>
                    <th>Date Created</th>
                </tr>
            </thead>
            <tbody class="records"></tbody>
        </table>
    </div>
  </div>
{% endblock %}

{% block extrajs %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.1.0/js.cookie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.0.0/lodash.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>

    <script type="text/javascript">
        $(function(){
            var token = 'dc61660cefcaab414581a46a';
            var application_id = '56a37dbd2cd1700e04ee9d84';
            var gotcha_client = 'http://gotcha.hipo.biz'
            var app_base_url = gotcha_client + '/api/applications/' + application_id;

            var compiled = _.template('<% _.forEach(records, function(record) { %>  <tr><td><%= record.Time %></td> <td><%= record.StatusCode %></td> <td><%= record.DateCreated %></td></tr><% }); %>');
            
            $.get(app_base_url + '/urls/{{ url_id }}?token='+ token, function(response){
                var records = JSON.parse(response);
                // Ad this data to table
                $('.records').append((compiled({'records': records})))

                // Collect chart data
                chartData = []
                $.each(records, function(i, url_record){
                    chartData[i] = [Date.parse(url_record["DateCreated"]), url_record["Time"]];
                });

                setTimeout(function(){
                $('#urlDetailChart').highcharts({
                    chart: {
                        zoomType: 'x'
                    },
                    title: {
                        text: 'Url Response Time Change Over Time'
                    },
                    subtitle: {
                        text: document.ontouchstart === undefined ?
                                'Click and drag in the plot area to zoom in' : 'Pinch the chart to zoom in'
                    },
                    xAxis: {
                        type: 'datetime'
                    },
                    yAxis: {
                        title: {
                            text: 'Exchange rate'
                        }
                    },
                    legend: {
                        enabled: false
                    },
                    plotOptions: {
                        area: {
                            fillColor: {
                                linearGradient: {
                                    x1: 0,
                                    y1: 0,
                                    x2: 0,
                                    y2: 1
                                },
                                stops: [
                                    [0, Highcharts.getOptions().colors[0]],
                                    [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                                ]
                            },
                            marker: {
                                radius: 2
                            },
                            lineWidth: 1,
                            states: {
                                hover: {
                                    lineWidth: 1
                                }
                            },
                            threshold: null
                        }
                    },

                    series: [{
                        type: 'area',
                        name: 'Response Time',
                        data: chartData
                    }]
                });
                }, 200);
            });
        });
    </script>
{% endblock %}
